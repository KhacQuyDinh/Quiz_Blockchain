<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="theme.css" type="text/css">
    <title>QUIZZES SMART CONTRACT</title>
    <script type='text/javascript' src='./node_modules/web3/dist/web3.min.js'></script>
    <script type='text/javascript' src='./node_modules/truffle-contract/dist/truffle-contract.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- SCRIPT FOR COUNTING TIME-->
    <script>
        let limitTime;
        let myTimer;
        function startTimer(duration, display) {
            let timer = duration, minutes, seconds;
            let timeOut = false;
            myTimer = setInterval(function () {
                minutes = parseInt(timer / 60, 10)
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                if (!timeOut) {
                    if (timer == 0) {
                        timeOut = true;
                    } else {
                        display.textContent = minutes + ":" + seconds;
                    }
                } else {
                    display.textContent = "Question Closed";
                    $('#btn_submit').html('NEXT');
                    clearInterval(myTimer);
                }

                if (--timer < 0) {
                    timer = duration;
                }

                if (localStorage.getItem('timeleft') > 0) {
                    localStorage.setItem('timeleft', localStorage.getItem('timeleft') - 1);
                }

            }, 1000);
        }

        function startCountDown(timeLeft) {
            display = document.querySelector('#time');
            if (timeLeft > 0) {
                startTimer(timeLeft, display);
            } else {
                $('#btn_submit').html("NEXT");
                display.textContent = "Question Closed";
                // display.textContent = "reload";
            }
        };
    </script>
</head>

<body class="bg-dark" style="background-size:cover;">
    <div class="container">
        <div class="row py-5 mx-5">
            <div class="align-self-center text-white col-md-4 bg-dark">
                <h1 class="text-center text-md-left display-3 text-light">Quiz Game</h1>
                <table class="table table-hover table-striped table-sm table-bordered">
                    <tbody>
                        <tr>
                            <td id='general_num_right_answer' style="color:#0DFF92;">General num correct answer:</td>
                            <td class="w-25 text-center"></td>
                        </tr>
                        <tr>
                            <td id='general_num_false_answer' style="color:#ff7f82;">General num wrong answer:</td>
                            <td class="text-center"></td>
                        </tr>
                        <tr>
                            <td id='balance' style="color: #e5ff60;">Balance:</td>
                            <td class="text-center"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="w-100 text-center">
                    <h3 id="time">00:00</h3>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body bg-dark w-100">
                        <h3 class="pb-3 text-center" id='questionId'>Question Number</h3>
                        <p class="text-center m-0" id='question'>This Is The Question ?</p>
                        <div class="text-center">
                            <img id="loader" src="https://loading.io/spinners/double-ring/lg.double-ring-spinner.gif" class="" width="10%">
                        </div>
                        <div class="mx-3 px-5">
                            <label>
                                <input type="radio" class="option-input radio" id="answer_A" name="user_answer" value="1">
                                <span></span>
                                <div id='des_A_right' class='right_des' style="color:#0DFF92;display:none;">Correct</div>
                                <div id='des_A_false' class='false_des' style="color:#ff7f82;display:none;">Wrong</div>
                            </label>
                            <label>
                                <input type="radio" class="option-input radio" id="answer_B" name="user_answer" value="2">
                                <span></span>
                                <div id='des_B_right' class='right_des' style="color:#0DFF92;display:none;">Correct</div>
                                <div id='des_B_false' class='false_des' style="color:#ff7f82;display:none;">Wrong</div>
                            </label>
                            <label>
                                <input type="radio" class="option-input radio" id="answer_C" name="user_answer" value="3">
                                <span></span>
                                <div id='des_C_right' class='right_des' style="color:#0DFF92;display:none;">Correct</div>
                                <div id='des_C_false' class='false_des' style="color:#ff7f82;display:none;">Wrong</div>
                            </label>
                            <label>
                                <input type="radio" class="option-input radio" id="answer_D" name="user_answer" value="4">
                                <span></span>
                                <div id='des_D_right' class='right_des' style="color:#0DFF92;display:none;">Correct</div>
                                <div id='des_D_false' class='false_des' style="color:#ff7f82;display:none;">Wrong</div>
                            </label>
                        </div>
                        <div class="text-center">
                            <button class="btn w-50 btn-outline-light m-1" id='btn_submit'>SUBMIT</button>
                            <button class="btn w-50 btn-outline-light m-1" id='btn_reload'>Reload</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>		
        //web3 is already set provider.
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            //else create new one.
            web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
        }
        //get the first account as defaultAccount in total 10 accounts which localhost gives.
        web3.eth.defaultAccount = web3.eth.accounts[0];
        //fill contract description.
        var quizContract = web3.eth.contract(
            [
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "time",
                            "type": "uint256"
                        }
                    ],
                    "name": "getTheNextQuiz",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [],
                    "name": "initQuizDb",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "quiz_id",
                            "type": "uint256"
                        },
                        {
                            "name": "user_answer_id",
                            "type": "uint256"
                        }
                    ],
                    "name": "submitAnswer",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "name": "general_num_right_answer",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "general_num_false_answer",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "total_quiz",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "quiz_id",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "question",
                            "type": "bytes"
                        },
                        {
                            "indexed": false,
                            "name": "answer_A",
                            "type": "bytes"
                        },
                        {
                            "indexed": false,
                            "name": "answer_B",
                            "type": "bytes"
                        },
                        {
                            "indexed": false,
                            "name": "answer_C",
                            "type": "bytes"
                        },
                        {
                            "indexed": false,
                            "name": "answer_D",
                            "type": "bytes"
                        }
                    ],
                    "name": "update_the_next_quiz_evt",
                    "type": "event"
                },
                {
                    "anonymous": false,
                    "inputs": [
                        {
                            "indexed": false,
                            "name": "isRight",
                            "type": "bool"
                        },
                        {
                            "indexed": false,
                            "name": "general_num_right_answer",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "general_num_false_answer",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "total_quiz",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "answer_check",
                            "type": "bytes"
                        },
                        {
                            "indexed": false,
                            "name": "user_answer_id",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "server_current_quiz_id",
                            "type": "uint256"
                        },
                        {
                            "indexed": false,
                            "name": "balance",
                            "type": "uint256"
                        }
                    ],
                    "name": "update_answer_evt",
                    "type": "event"
                },
                {
                    "inputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "balanceOf",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getCurrentBalance",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getCurrentQuizId",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getDefaultTotalQuiz",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "name": "quiz_id",
                            "type": "uint256"
                        }
                    ],
                    "name": "getQuizStartingTimeById",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "name": "quiz_set",
                    "outputs": [
                        {
                            "name": "id",
                            "type": "uint256"
                        },
                        {
                            "name": "question",
                            "type": "bytes"
                        },
                        {
                            "name": "answer_A",
                            "type": "bytes"
                        },
                        {
                            "name": "answer_B",
                            "type": "bytes"
                        },
                        {
                            "name": "answer_C",
                            "type": "bytes"
                        },
                        {
                            "name": "answer_D",
                            "type": "bytes"
                        },
                        {
                            "name": "answer_check",
                            "type": "bytes"
                        },
                        {
                            "name": "answer_check_id",
                            "type": "uint256"
                        },
                        {
                            "name": "startingTime",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                }
            ]
        );
        //fill address in the quote.
        var quizInstant = quizContract.at("0x6ea35a24d50993e8481c20741777aaac58d3b769");
        //console.log('318: ' + localStorage.getItem('user_quiz_id'));
        //if the cookie is not set, init cookie.				
        //using event to update the quiz.
        var update_answer_evt = quizInstant.update_answer_evt();
        //func when have instructorEvent be called. 
        update_answer_evt.watch(function (error, result) {
            //hide loader.
            //show info including name-age or error.
            if (!error) {
                //increase and decrease wrong_answer or correct_answer.
                //the quiz is answered.
                localStorage.setItem('user_quiz_id', -1);
                //check end.
                if (localStorage.getItem('default_total_quiz')
                    - result.args.server_current_quiz_id - 1 == 0) {
                    $('#btn_submit').html('GAME END');
                    //delete cookie everytime endgame.
                    localStorage.setItem('user_quiz_id', -2);
                    // console.log('510, end game');
                } else {
                    $("#loader").hide();
                    $('#btn_submit').html('NEXT');
                }
                //update info
                ///#start region:
                //game_general_num_right_answer              
                $('#general_num_right_answer').next().html(result.args.general_num_right_answer + '/' + result.args.total_quiz);
                //game_general_num_false_answer
                $('#general_num_false_answer').next().html(result.args.general_num_false_answer + '/' + result.args.total_quiz);
                //update balance token.
                $('#balance').next().html("" + result.args.balance);
                //update answer.				
                switch (parseInt(result.args.user_answer_id)) {
                    case 1:
                        if (result.args.isRight) {
                            $('#des_A_right').fadeIn(1000);
                            $('#des_A_right').delay(500);
                            $('#des_A_right').slideUp();
                        } else {
                            $('#des_A_false').fadeIn(1000);
                            $('#des_A_false').delay(500);
                            $('#des_A_false').slideUp();
                        }
                        break;
                    case 2:
                        if (result.args.isRight) {
                            $('#des_B_right').fadeIn(1000);
                            $('#des_B_right').delay(500);
                            $('#des_B_right').slideUp();
                        } else {
                            $('#des_B_false').fadeIn(1000);
                            $('#des_B_false').delay(500);
                            $('#des_B_false').slideUp();
                        }
                        break;
                    case 3:
                        if (result.args.isRight) {
                            $('#des_C_right').fadeIn(1000);
                            $('#des_C_right').delay(500);
                            $('#des_C_right').slideUp();
                        } else {
                            $('#des_C_false').fadeIn(1000);
                            $('#des_C_false').delay(500);
                            $('#des_C_false').slideUp();
                        }
                        break;
                    case 4:
                        if (result.args.isRight) {
                            $('#des_D_right').fadeIn(1000);
                            $('#des_D_right').delay(500);
                            $('#des_D_right').slideUp();
                        } else {
                            $('#des_D_false').fadeIn(1000);
                            $('#des_D_false').delay(500);
                            $('#des_D_false').slideUp();
                        }
                        break;
                    default:
                        console.log('in default');
                }
                //#end region.              
            } else {
                console.log(error);
            }
        });
        //using event to update the quiz.
        var update_the_next_quiz_evt = quizInstant.update_the_next_quiz_evt();
        //func when have getTheNextQuiz() be called. 
        update_the_next_quiz_evt.watch(function (error, result) {
            console.log('update quiz event')
            //hide loader.
            $("#loader").hide();
            //show info question.
            if (result) {
                if (result.args.quiz_id != localStorage.getItem('user_quiz_id')) {
                    startCountDown(30);
                } else {
                    if ((Math.floor(30 - (Date.now() - Number(localStorage.getItem('startTime'))) / 1000 )) > 0) {
                        startCountDown(Math.floor(30 - (Date.now() - Number(localStorage.getItem('startTime'))) / 1000));
                    }
                }
                //if not error and the question is not be answered
                console.log('409: ' + result.args.quiz_id);
                //update value of user_quiz_id as runtime variable.						
                localStorage.setItem('user_quiz_id', result.args.quiz_id);
                $("#loader").hide();
                //we need realtime to update here..
                $('#general_num_right_answer').next().html(result.args.general_num_right_answer + '/' + result.args.total_quiz);
                $('#general_num_false_answer').next().html(result.args.general_num_false_answer + '/' + result.args.total_quiz);

                //update balance because the lost token when geting the next quiz.
                //the view func doesn't cost ether
                console.log('balance: ' + quizInstant.getCurrentBalance());
                $('#balance').next().html('' + quizInstant.getCurrentBalance());
                var question_num = parseInt(result.args.quiz_id) + 1;
                $('#questionId').html('Question number ' + question_num);
                $('#question').html(web3.toAscii(result.args.question));
                var ansA = $('#answer_A').next()[0];
                var ansB = $('#answer_B').next()[0];
                var ansC = $('#answer_C').next()[0];
                var ansD = $('#answer_D').next()[0];
                ansA.textContent = web3.toAscii(result.args.answer_A);
                ansB.textContent = web3.toAscii(result.args.answer_B);
                ansC.textContent = web3.toAscii(result.args.answer_C);
                ansD.textContent = web3.toAscii(result.args.answer_D);
                //update button.
                if ((Math.floor(30 - (Date.now() - Number(localStorage.getItem('startTime'))) / 1000 )) > 0) {
                    $('#btn_submit').html('SUBMIT');
                } else {
                    $('#btn_submit').html('NEXT');
                }
                //reset result.
                //uncheck all radio buttons.
                $('#answer_A').prop('checked', false);
                $('#answer_B').prop('checked', false);
                $('#answer_C').prop('checked', false);
                $('#answer_D').prop('checked', false);
            }
        });
        //after submit we call event.
        $('#btn_submit').click(function () {
            //show loader..
            $("#loader").show();
            //condition.
            if (($('#btn_submit').text() == 'NEXT' || $('#btn_submit').text() == 'START')) {
                var startTime = Date.now();
                localStorage.setItem('startTime', startTime);
                quizInstant.getTheNextQuiz(startTime, function (error, result) {
                    if (!error) {
                        console.log('485: get new quiz');
                    } else {
                        //when server throw error that means have no more quiz.
                        console.log('error in line 413: ' + error);
                        $('#btn_submit').html('GAME END');
                        //delete cookie everytime endgame.
                        localStorage.setItem('user_quiz_id', -2);
                        // console.log('510, end game');
                    }
                });
            } else {
                if ($('#btn_submit').text() == 'SUBMIT') {
                    var user_answer_id = $('input[name=user_answer]:checked').val();
                    //if choosen an answer.
                    if (user_answer_id != undefined) {
                        clearInterval(myTimer);
                        //get user_quiz_id as runtime variable.			
                        var user_quiz_id = localStorage.getItem('user_quiz_id');
                        quizInstant.submitAnswer(user_quiz_id, user_answer_id, (err, res) => {
                            if (err) {
                                //hide loader..
                                $("#loader").hide();
                                console.log('error in line 425: ' + err);
                            } else {
                            }
                        });
                    }
                }
            }
        });
    </script>


    <script>
        // Run on page load
        window.onload = function () {
            if (document.querySelector('#time').textContent === "00:00") {
                $('#btn_submit').html("NEXT");
                console.log('reload');
            }
            // console.log('reload');
            var ansA = $('#answer_A').next()[0];
            var ansB = $('#answer_B').next()[0];
            var ansC = $('#answer_C').next()[0];
            var ansD = $('#answer_D').next()[0];
            ansA.textContent = localStorage.getItem('answerA');
            ansB.textContent = localStorage.getItem('answerB');
            ansC.textContent = localStorage.getItem('answerC');
            ansD.textContent = localStorage.getItem('answerD');
            $('#questionId').html(localStorage.getItem('questionNumber'));
            $('#question').html(localStorage.getItem('question'));
            // clearInterval(myTimer);
            // if ((Math.floor(30 - (Date.now() - Number(localStorage.getItem('startTime'))) / 1000 )) > 0) {
            //     startCountDown(Math.floor(30 - (Date.now() - Number(localStorage.getItem('startTime'))) / 1000));
            // }
            console.log(Math.floor(30 - (Date.now() - Number(localStorage.getItem('startTime'))) / 1000));
        }

        // Before refreshing the page, save the form data to sessionStorage
        window.onbeforeunload = function () {
            clearInterval(myTimer);
            var ansA = $('#answer_A').next()[0];
            var ansB = $('#answer_B').next()[0];
            var ansC = $('#answer_C').next()[0];
            var ansD = $('#answer_D').next()[0];
            localStorage.setItem("answerA", ansA.textContent);
            localStorage.setItem("answerB", ansB.textContent);
            localStorage.setItem("answerC", ansC.textContent);
            localStorage.setItem("answerD", ansD.textContent);
            localStorage.setItem("questionNumber", $('#questionId').html());
            localStorage.setItem("question", $('#question').html());
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</body>

</html>