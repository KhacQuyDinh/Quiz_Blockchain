<!DOCTYPE html>
<html lang='en'>

<head>
	<meta charset='UTF-8'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0'>
	<meta http-equiv='X-UA-Compatible' content='ie=edge'>
	<title>Coursetro Smart Contract</title>

	<link rel='stylesheet' type='text/css' href='quiz.css'>

	<script type="text/javascript" src='./node_modules/web3/dist/web3.min.js'></script>

	<script type="text/javascript" src='./node_modules/truffle-contract/dist/truffle-contract.min.js'></script>
</head>

<body>
	<div class='container'>

		<h1>QUIZ GAME</h1>
		<span id='num_right_answer'>0</span>
		<br>
		<span id='num_false_answer'>0</span>
		<hr>

		<p id='questionId'></p>
		<p id='question'></p>

		<form action=''>
			<input type='radio' name='user_answer' value='1' id='answer_A'>
			<label id='des_A_right' class='right_des'></label>
			<label id='des_A_false' class='false_des'></label>
			<br>
			<input type='radio' name='user_answer' value='2' id='answer_B'>
			<label id='des_B_right' class='right_des'></label>
			<label id='des_B_false' class='false_des'></label>
			<br>
			<input type='radio' name='user_answer' value='3' id='answer_C'>
			<label id='des_C_right' class='right_des'></label>
			<label id='des_C_false' class='false_des'></label>
			<br>
			<input type='radio' name='user_answer' value='4' id='answer_D'>
			<label id='des_D_right' class='right_des'></label>
			<label id='des_D_false' class='false_des'></label>
			<br>
		</form>

		<button id='btn_submit'>START</button>
		<br>
		<br>
		<button id='btn_reset'>RESET THE QUESTION</button>

	</div>

	<script src='https://code.jquery.com/jquery-3.2.1.slim.min.js'></script>

	<script>		
		//web3 is already set provider.
		if (typeof web3 !== 'undefined') {
			web3 = new Web3(web3.currentProvider);
		} else {
			//else create new one.
			web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
		}

		//get the first account as defaultAccount in total 10 accounts which localhost gives.
		web3.eth.defaultAccount = web3.eth.accounts[0];

		//fill contract description.
		var quizContract = web3.eth.contract(
			[
	{
		"constant": false,
		"inputs": [],
		"name": "getTheNextQuiz",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "quiz_id",
				"type": "uint8"
			}
		],
		"name": "getTheNextQuizById",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getCurrentQuizId",
		"outputs": [
			{
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "getDefaultTotalQuiz",
		"outputs": [
			{
				"name": "",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"name": "quiz_set",
		"outputs": [
			{
				"name": "id",
				"type": "uint8"
			},
			{
				"name": "question",
				"type": "bytes"
			},
			{
				"name": "answer_A",
				"type": "bytes"
			},
			{
				"name": "answer_B",
				"type": "bytes"
			},
			{
				"name": "answer_C",
				"type": "bytes"
			},
			{
				"name": "answer_D",
				"type": "bytes"
			},
			{
				"name": "answer_check",
				"type": "bytes"
			},
			{
				"name": "answer_check_id",
				"type": "uint8"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "quiz_id",
				"type": "uint8"
			},
			{
				"name": "user_answer_id",
				"type": "uint8"
			}
		],
		"name": "submitAnswer",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "isRight",
				"type": "bool"
			},
			{
				"indexed": false,
				"name": "num_right_answer",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "num_false_answer",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "total_quiz",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "answer_check",
				"type": "bytes"
			},
			{
				"indexed": false,
				"name": "user_answer_id",
				"type": "uint8"
			}
		],
		"name": "update_quiz_evt",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "num_right_answer",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "num_false_answer",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "total_quiz",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "quiz_id",
				"type": "uint8"
			},
			{
				"indexed": false,
				"name": "question",
				"type": "bytes"
			},
			{
				"indexed": false,
				"name": "answer_A",
				"type": "bytes"
			},
			{
				"indexed": false,
				"name": "answer_B",
				"type": "bytes"
			},
			{
				"indexed": false,
				"name": "answer_C",
				"type": "bytes"
			},
			{
				"indexed": false,
				"name": "answer_D",
				"type": "bytes"
			}
		],
		"name": "update_the_next_quiz_evt",
		"type": "event"
	}
]
		);

		//fill address in the quote.
		var quizInstant = quizContract.at('0x6abdf6a5fa18fae2ca0a24259e0f8a87bbb73965');

		//using event to update the quiz.
		var update_quiz_evt = quizInstant.update_quiz_evt();

		//func when have instructorEvent be called. 
		update_quiz_evt.watch(function (error, result) {
			//hide loader.

			//show info including name-age or error.
			if (!error) {
				//update info
				//#start region:              
				$('#num_right_answer').html('Number right answer: ' + result.args.num_right_answer + '/' + result.args.total_quiz);
				$('#num_false_answer').html('Number false answer: ' + result.args.num_false_answer + '/' + result.args.total_quiz);

				//update answer.				
				switch (parseInt(result.args.user_answer_id)) {
					case 1:
						if (result.args.isRight) {
							$('#des_A_right').html('Correct');
							$('#des_A_false').html('');
						} else {
							$('#des_A_right').html('');
							$('#des_A_false').html('False');
						}

						break;

					case 2:
						if (result.args.isRight) {
							$('#des_B_right').html('Correct');
							$('#des_B_false').html('');
						} else {
							$('#des_B_right').html('');
							$('#des_B_false').html('False');
						}

						break;


					case 3:
						if (result.args.isRight) {
							$('#des_C_right').html('Correct');
							$('#des_C_false').html('');
						} else {
							$('#des_C_right').html('');
							$('#des_C_false').html('False');
						}

						break;

					case 4:
						if (result.args.isRight) {
							$('#des_D_right').html('Correct');
							$('#des_D_false').html('');
						} else {
							$('#des_D_right').html('');
							$('#des_D_false').html('False');
						}

						break;

					default:
					console.log('in default');
				}
				//#end region.              
			} else {
				console.log(error);
			}
		});

		//using event to update the quiz.
		var update_the_next_quiz_evt = quizInstant.update_the_next_quiz_evt();

		//func when have getTheNextQuiz() be called. 
		update_the_next_quiz_evt.watch(function (error, result) {
			//hide loader.

			//show info question.
			if (!error) {
				$('#num_right_answer').html('Number right answer: ' + result.args.num_right_answer + '/' + result.args.total_quiz);
				$('#num_false_answer').html('Number false answer: ' + result.args.num_false_answer + '/' + result.args.total_quiz);
				var question_num = parseInt(result.args.quiz_id) + 1;
				$('#questionId').html('Question number ' + question_num);
				$('#question').html(web3.toAscii(result.args.question));
				$('#answer_A').html(web3.toAscii(result.args.answer_A));
				$('#answer_B').html(web3.toAscii(result.args.answer_B));
				$('#answer_C').html(web3.toAscii(result.args.answer_C));
				$('#answer_D').html(web3.toAscii(result.args.answer_D));
				//update button.
				$('#btn_submit').html('SUBMIT');
				//reset result.
				$('#des_A_right').html('');
				$('#des_A_false').html('');
				$('#des_B_right').html('');
				$('#des_B_false').html('');
				$('#des_C_right').html('');
				$('#des_C_false').html('');
				$('#des_D_right').html('');
				$('#des_D_false').html('');
				//uncheck all radio buttons.
				$('#answer_A').prop('checked', false);
				$('#answer_B').prop('checked', false);
				$('#answer_C').prop('checked', false);
				$('#answer_D').prop('checked', false);
			}
		});

		console.log('line 392: ' + (quizInstant.getCurrentQuizId() == quizInstant.getDefaultTotalQuiz()));
		//start game.
		if (parseInt(quizInstant.getCurrentQuizId()) - parseInt(quizInstant.getDefaultTotalQuiz()) == 0) {
			$('#btn_submit').html('START');
		}

		//reset the question. for example loading the page.	
		$('#btn_reset').click(function () {
			var quiz_id = quizInstant.getCurrentQuizId();
			if (quiz_id >= 0 && quizInstant.getDefaultTotalQuiz() - quiz_id > 0) {
				quizInstant.getTheNextQuizById(quiz_id);
			}
		});

		//after submit we call event.
		$('#btn_submit').click(function () {
			//show loader..
			var quiz_id = quizInstant.getCurrentQuizId();
			var total_quiz_id = quizInstant.getDefaultTotalQuiz();			

			if (($('#btn_submit').text() == "NEXT" || $('#btn_submit').text() == "START")
				//if quiz_id - end_quiz_id == 0 then for the case start
				&& (total_quiz_id - quiz_id - 1 > 0 || quiz_id - total_quiz_id == 0)) {
				quizInstant.getTheNextQuiz(function (error, result) {
					if (!error) {
						//will call event.
						console.log('result: ' + result[0] + ' -> ' + result[1] + ' -> ' + result[2] + ' -> ' + result[3]);
					} else {
						console.log('error in line 413: ' + error)
					}
				});
			} else {				
				if ($('#btn_submit').text() == "SUBMIT") {
					console.log('431 quiz_id: ' + quiz_id);
					var user_answer_id = $('input[name=user_answer]:checked').val();
					//if choosen an answer.
					if (user_answer_id != undefined) {
						quizInstant.submitAnswer(quiz_id, user_answer_id, (err, res) => {
							if (err) {
								//hide loader..
								console.log('error in line 425: ' + err);
							} else {
								//will call event.
								$('#btn_submit').html('NEXT');							
							}
						});
					}
				}

				if (total_quiz_id - quiz_id - 1 == 0) {
					$('#btn_submit').html('GAME END');
				} 
			}
		});

	</script>
</body>

</html>